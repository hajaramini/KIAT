---
title: "eQTL"
output: html_document
---
Purpose of this script is to find loci controlling expression of different genes. We will firstly focus on fatty acid related genes.  

### import data, get genes with detectable expression  
```{r}
read_count_F2 <- read.table("~/F2/data/est.counts.F2.tsv.gz", header = T, row.names = 1)
dim(read_count_F2) # 101040    166

# remove lowly expressed genes 
read.count.small <- read_count_F2[rowSums(read_count_F2 > 10) >= 166*0.25,]
dim(read.count.small) # 59934   131  
colnames(read.count.small)
save(read.count.small, file="~/F2/output/read.count.small.Rdata")
```

### voom transformation 
```{r}
# source("https://bioconductor.org/biocLite.R")
# biocLite("DESeq2")
library("DESeq2")

# define sample 
read.count.sample <- data.frame(group=factor(colnames(read_count_F2)))

dds.f2 <- DESeqDataSetFromMatrix(countData = round(read.count.small), colData = read.count.sample, design = ~ group) 
vsd.f2 <- varianceStabilizingTransformation(dds.f2)
vstMat.f2 <- assay(vsd.f2)
colnames(vstMat.f2) <- colnames(read.count.small)
```

### scale and center
```{r}
dim(vstMat.f2) # 56180   166 
vstMat.f2.centered.scaled <- scale(vstMat.f2, center = TRUE, scale = TRUE) # center to zero
save(vstMat.f2.centered.scaled, file = "~/F2/output/vstMat.f2.centered.scaled.Rdata")
```

### get fatty acid & lipid genes 
```{r}
load("~/F2/output/vstMat.f2.centered.scaled.Rdata") 
vstMat.f2.centered.scaled[1:10, 1:10]

# get lipid and fatty acid related genes using GO and IPR term 
# cat Brassica_napus_IPR.withdescription.gz | grep "fatty\|lipid" > fatty_acid_related/lipid_fatty_acid_IPR

# cat Brassica_napus_GO | awk '{print $2}' > GO_list 

# cat GO_list | sort | uniq > GO_list_unique 

# extract GO annotation from http://yeastmine.yeastgenome.org/yeastmine/bag.do save as GO_annotation.csv 

# cat GO_annotation.csv | grep "fatty\|lipid" | awk '{print $1}' | sort | uniq | sed 's/"//g' > fatty_acid_lipd_GO 

# cat lipid_fatty_acid_* | awk '{print $1}' | sort | uniq > lipid_fatty_acid_genes
lipid_fatty_acid_genes <- read.table("~/Reference/B.napus/fatty_acid_related/lipid_fatty_acid_genes", header = F, stringsAsFactors = FALSE)
dim(lipid_fatty_acid_genes) # 7346 
```

### load libs
```{r}
library(tidyverse)
library(qtl)
library(snowfall)
library(ggrepel) 
library(Biostrings)
source("~/KIAT/function_BnRNAseq.R")
```

### format data for QTL analysis (use v1 map)
```{r}
# geno data 
F2_geno_data_2_Ae_Ol_new <- read.table("~/F2/data/F2_geno_data_2_Ae_Ol_new.txt")
dim(F2_geno_data_2_Ae_Ol_new) # 3443 166 
F2_geno_data_2_Ae_Ol_new[1:10, 1:10]

# pheno (gene counts)
load("~/F2/output/vstMat.f2.centered.scaled.Rdata")
vstMat.f2.centered.scaled <- as.data.frame(vstMat.f2.centered.scaled)
vstMat.f2.centered.scaled[1:10, 1:10]

# get only fatty acid & lipid related genes 
vstMat.f2.centered.scaled$geneID <- rownames(vstMat.f2.centered.scaled)
vstMat.f2.centered.scaled$geneID
lipid_fatty_acid_genes <- read.table("~/Reference/B.napus/fatty_acid_related/lipid_fatty_acid_genes", header = F, stringsAsFactors = FALSE)
lipid_fatty_acid_genes$geneID <- lipid_fatty_acid_genes$V1 

lipid_fatty_acid_genes.expression <- 
  vstMat.f2.centered.scaled %>%
    semi_join(lipid_fatty_acid_genes) 

rownames(lipid_fatty_acid_genes.expression) <- lipid_fatty_acid_genes.expression$geneID
lipid_fatty_acid_genes.expression <- 
  lipid_fatty_acid_genes.expression %>% 
    dplyr::select(-geneID)

colnames(lipid_fatty_acid_genes.expression) <- gsub("Sample_F2", "ID", colnames(lipid_fatty_acid_genes.expression))
dim(lipid_fatty_acid_genes.expression) # 4943 166 

# combine geno & pheno for QTL analysis 
colnames(F2_geno_data_2_Ae_Ol_new) <- gsub("X", "ID_", colnames(F2_geno_data_2_Ae_Ol_new))

F2_geno_data_2_Ae_Ol_new.t <- as.data.frame(t(F2_geno_data_2_Ae_Ol_new))
F2_geno_data_2_Ae_Ol_new.t$ID <- rownames(F2_geno_data_2_Ae_Ol_new.t)
lipid_fatty_acid_genes.expression.t <- as.data.frame(t(lipid_fatty_acid_genes.expression)) 
lipid_fatty_acid_genes.expression.t$ID <- rownames(lipid_fatty_acid_genes.expression.t)

F2_geno_data_2_Ae_Ol_new.2 <- 
F2_geno_data_2_Ae_Ol_new.t %>% 
  left_join(lipid_fatty_acid_genes.expression.t) %>% 
  dplyr::select(-ID) 

dim(F2_geno_data_2_Ae_Ol_new.2) # 166 8386 
F2_geno_data_2_Ae_Ol_new.2[1:10, 3440:3450] 
F2_geno_data_2_Ae_Ol_new.2 <- t(F2_geno_data_2_Ae_Ol_new.2)
write.table(F2_geno_data_2_Ae_Ol_new.2, file = "~/F2/data/QTL_analysis/F2_geno_data_2_Ae_Ol_new.2.txt")

# change file format in linux 
# cat F2_geno_data_2_Ae_Ol_new.2.txt | sed 's/"//g' | awk '{first = $1; $1 = ""; print $0}' > tmp
# tail -8386 tmp > tmp.1

write.table(rownames(F2_geno_data_2_Ae_Ol_new.2), file = "~/F2/data/QTL_analysis/marker_info.txt" )
# cat marker_info.txt | awk '{print "*"$2}' | tail -8386 | sed 's/"//g' > marker_info_reform.txt
# paste marker_info_reform.txt tmp.1  | tr "\t" "\ " > F2_geno_for_one_map.txt 
# paste marker_info_reform.txt tmp.1 | awk '{print $1 " " $2}' > F2_geno_for_one_map.txt
# cat header_one_map_input F2_geno_for_one_map.txt > F2_geno_for_one_map_final.txt
# change header info: maker number to the right marker number & phenotype data number 
```

### load data (gen file & phe file)
```{r}
LG.f2 <- read.cross("mm", file = "~/F2/data/QTL_analysis/F2_geno_for_one_map_final.txt", mapfile = "~/F2/data/QTL_analysis/LG.f2.madmapper.map") 
save(LG.f2, file = "~/F2/output/QTL_analysis/LG.f2.fatty_acid_lipid.Rdata")
```

### re-estimate map
```{r} 
LG.f2

LG.f2.before.crossover <- LG.f2

for (chr in names(LG.f2$geno)) { # for each chromosome in cross genotype data
  my.chr <- get(chr,LG.f2$geno) # return the genotype data, including data & map
  print(paste(chr,"NA before",sum(is.na(my.chr$data)))) 
  if(ncol(my.chr$data) > 3) { 
    my.chr$data[,2:(ncol(my.chr$data)-1)] <- sapply(2:(ncol(my.chr$data)-1),function(i) {
      apply(my.chr$data[,(i-1):(i+1)],1,function(gt) {
        if (any(is.na(gt))) return(gt[2]) #technically should be looking at the next genotyped marker.
        if ( (length(unique(gt)) == 2) & (gt[1] == gt[3])) return(NA)
        if ( length(unique(gt))  == 3) return(NA)
        return(gt[2])
      })
    })
  }
  LG.f2$geno <- within(LG.f2$geno,assign(chr,my.chr))
  print(paste(chr,"NA after",sum(is.na(get(chr,LG.f2$geno)$data))))
}  

map.new <- est.map(LG.f2,verbose=T,error.prob=.01) 
save(map.new, file = "~/F2/output/QTL_analysis/map.new.fatty_acid_lipid.Rdata")

LG.f2 <- replace.map(LG.f2, map.new)
LG.f2.after.crossover <- LG.f2

plot.map(LG.f2.after.crossover, alternate.chrid = T) # the old genetic map
plot.map(LG.f2.before.crossover,LG.f2.after.crossover, alternate.chrid = T) # genetic map comparison 
```    

# deal with LG10 
```{r}
load("~/F2/output/QTL_analysis/LG.f2.after.crossover_fatty_acid_lipid.Rdata")
summaryMap(LG.f2.after.crossover) # 2853. 2

set.seed(16)
LG.f2.after.crossover <- orderMarkers(LG.f2.after.crossover, chr = c(10), 
	                        window = 5, use.ripple = TRUE, maxit = 4000, 
	                        error.prob = 0.0001, verbose = T) 

plotMap(LG.f2.after.crossover, chr = '10')
summaryMap(LG.f2.after.crossover)
save(LG.f2.after.crossover, file = "~/F2/output/QTL_analysis/LG.f2.after.crossover_fatty_acid_lipid.Rdata")
```

### scanone eQTL (on the two FAD genes only)
```{r}
load("~/F2/output/QTL_analysis/LG.f2.after.crossover_fatty_acid_lipid.Rdata")
summaryMap(LG.f2.after.crossover)

LG.f2.after.crossover <- sim.geno(LG.f2.after.crossover,step=1,n.draws=32) # imputation? 
LG.f2.after.crossover <- calc.genoprob(LG.f2.after.crossover,step=1) 
LG.f2.after.crossover$pheno <- LG.f2.after.crossover$pheno[,c("BnaA08g12780D", "BnaC03g67820D")] 

system.time(
scanone.perm.imp <- 
  sfLapply(seq_along(LG.f2.after.crossover$pheno), function(trait){
    print(trait) # print doesn't work in here 
    tmp <-scanone(LG.f2.after.crossover,pheno.col = trait, method="imp",n.perm=1000, n.cluster = 12, verbose = T)
    summary(tmp)[1] # #keep the 95th percentile for future use.This corresponds to p <0.05
  }) # takes 40 mins to finish 
) 

  #  user  system elapsed 
  # 1.020   1.200 394.109 

sfStop() 

names(scanone.perm.imp) <- colnames(LG.f2.after.crossover$pheno) 

system.time(
scanone.imp <- 
lapply(seq_along(LG.f2.after.crossover$pheno), function(trait) {
  print(trait)
  scanone(LG.f2.after.crossover,pheno.col=trait,method="imp", chr = 01)
}) 
) 
  #  user  system elapsed 
  # 6.124   3.420   8.849 
names(scanone.imp) <- colnames(LG.f2.after.crossover$pheno) 
# plot 
save(scanone.perm.imp, scanone.imp, file = "~/F2/output/QTL_analysis/eQTL_twogenes.Rdata")

png("~/F2/output/QTL_analysis/figure/scanone.imp.BnaA08g12780D.png", width = 8, height = 8, units = "in", res = 300)
scanone.imp.BnaA08g12780D <- scanone(LG.f2.after.crossover,pheno.col="BnaA08g12780D",method="imp") # 
plot(scanone.imp.BnaA08g12780D,bandcol="gray90", main="BnaA08g12780D")
abline(h=scanone.perm.imp[["BnaA08g12780D"]],lty=2) #add permuation threshold
dev.off()

png("~/F2/output/QTL_analysis/figure/scanone.imp.BnaC03g67820D.png", width = 8, height = 8, units = "in", res = 300)
scanone.imp.BnaC03g67820D <- scanone(LG.f2.after.crossover,pheno.col="BnaC03g67820D",method="imp") # 
plot(scanone.imp.BnaC03g67820D,bandcol="gray90", main="BnaC03g67820D", ylim=c(0, 30))
abline(h=scanone.perm.imp[["BnaC03g67820D"]],lty=2) #add permuation threshold
dev.off() 
```

### eQTL on all fatty acid and lipid genes 
```{r}
# https://github.com/leejimmy93/KIAT/blob/master/F2/scanone_fatty_acid_lipid.R
load("/Network/Servers/avalanche.plb.ucdavis.edu/Volumes/Mammoth/Users/ruijuanli/F2/output/QTL_analysis/scanone.imp_fatty_acid_lipid.Rdata")
scanone.imp_fatty_acid_lipid <- scanone.imp
scanone.imp_fatty_acid_lipid

# permutation... just on some genes? 
```

### on all genes
### combine geno & expression data 
```{r}
load("~/F2/output/vstMat.f2.centered.scaled.Rdata")
F2_geno_data_2_Ae_Ol_new <- read.table("~/F2/data/F2_geno_data_2_Ae_Ol_new.txt")
dim(F2_geno_data_2_Ae_Ol_new) # 3443 166 
dim(vstMat.f2.centered.scaled) # 56180   166

colnames(F2_geno_data_2_Ae_Ol_new) <- gsub("X", "ID_", colnames(F2_geno_data_2_Ae_Ol_new))
F2_geno_data_2_Ae_Ol_new.t <- as.data.frame(t(F2_geno_data_2_Ae_Ol_new))
F2_geno_data_2_Ae_Ol_new.t$ID <- rownames(F2_geno_data_2_Ae_Ol_new.t)

colnames(vstMat.f2.centered.scaled) <- gsub("Sample_F2", "ID", colnames(vstMat.f2.centered.scaled))
vstMat.f2.centered.scaled.t <- as.data.frame(t(vstMat.f2.centered.scaled))
vstMat.f2.centered.scaled.t$ID <- rownames(vstMat.f2.centered.scaled.t)

F2_geno_data_2_Ae_Ol_new.2 <- 
F2_geno_data_2_Ae_Ol_new.t %>% 
  left_join(vstMat.f2.centered.scaled.t) %>% 
  dplyr::select(-ID) 

dim(F2_geno_data_2_Ae_Ol_new.2) # 166 59623 
F2_geno_data_2_Ae_Ol_new.2 <- t(F2_geno_data_2_Ae_Ol_new.2)
write.table(F2_geno_data_2_Ae_Ol_new.2, file = "~/F2/data/QTL_analysis/F2_geno_data_2_Ae_Ol_new.2_all_expressed_genes.txt") 
```

```{r} 
# change file format in linux 
# cat F2_geno_data_2_Ae_Ol_new.2_all_expressed_genes.txt | sed 's/"//g' | awk '{first = $1; $1 = ""; print $0}' > tmp 
# tail -59623 tmp > tmp.1

write.table(rownames(F2_geno_data_2_Ae_Ol_new.2), file = "~/F2/data/QTL_analysis/marker_info_all_expressed_genes.txt" )
# cat marker_info_all_expressed_genes.txt | awk '{print "*"$2}' | tail -59623 | sed 's/"//g' > marker_info_reform.txt
# paste marker_info_reform.txt tmp.1  | tr "\t" "\ " > F2_geno_for_one_map.txt 
# cat header_one_map_input F2_geno_for_one_map.txt >  F2_geno_for_one_map_final_all_expressed_gene.txt 
# change header info: maker number to the right marker number & phenotype data number 
```

### load data 
```{r}
LG.f2 <- read.cross("mm", file = "~/F2/data/QTL_analysis/F2_geno_for_one_map_final_all_expressed_gene.txt", mapfile = "~/F2/data/QTL_analysis/LG.f2.madmapper.map") ### takes one day to read in this data... 
save(LG.f2, file = "~/F2/output/QTL_analysis/LG.f2.all_expressed_genes.Rdata")
important_eQTL <- LG.f2 
important_eQTL
LG.f2
load("/Network/Servers/avalanche.plb.ucdavis.edu/Volumes/Mammoth/Users/ruijuanli/F2/output/QTL_analysis/LG.f2.fatty_acid_lipid.Rdata")
LG.f2$pheno %>% dim()
```

### re-estimate map
```{r} 
LG.f2

LG.f2.before.crossover <- LG.f2

for (chr in names(LG.f2$geno)) { # for each chromosome in cross genotype data
  my.chr <- get(chr,LG.f2$geno) # return the genotype data, including data & map
  print(paste(chr,"NA before",sum(is.na(my.chr$data)))) 
  if(ncol(my.chr$data) > 3) { 
    my.chr$data[,2:(ncol(my.chr$data)-1)] <- sapply(2:(ncol(my.chr$data)-1),function(i) {
      apply(my.chr$data[,(i-1):(i+1)],1,function(gt) {
        if (any(is.na(gt))) return(gt[2]) #technically should be looking at the next genotyped marker.
        if ( (length(unique(gt)) == 2) & (gt[1] == gt[3])) return(NA)
        if ( length(unique(gt))  == 3) return(NA)
        return(gt[2])
      })
    })
  }
  LG.f2$geno <- within(LG.f2$geno,assign(chr,my.chr))
  print(paste(chr,"NA after",sum(is.na(get(chr,LG.f2$geno)$data))))
}  

map.new <- est.map(LG.f2,verbose=T,error.prob=.01) 

LG.f2 <- replace.map(LG.f2, map.new)
LG.f2.after.crossover <- LG.f2

plot.map(LG.f2.after.crossover, alternate.chrid = T) # the old genetic map
summaryMap(LG.f2.after.crossover) # 2853 

# fix LG10 problem using ripple 
set.seed(16)
LG.f2.after.crossover <- orderMarkers(LG.f2.after.crossover, chr = c(10), 
	                        window = 5, use.ripple = TRUE, maxit = 4000, 
	                        error.prob = 0.0001, verbose = T) 

plotMap(LG.f2.after.crossover, chr = '10')
summaryMap(LG.f2.after.crossover) # 2884
save(LG.f2.after.crossover, file = "~/F2/output/QTL_analysis/LG.f2.after.crossover_all_expressed_genes.Rdata") 
```     

### eQTL analysis on cabernet 
1) running eQTL takes a long time, so I split the 50,000 genes into 10 subset, and run scanone on subset in parallel. 
https://github.com/leejimmy93/KIAT_cabernet/blob/master/F2/scanone_all_expressed_genes_1.R ... https://github.com/leejimmy93/KIAT_cabernet/blob/master/F2/scanone_all_expressed_genes_10.R
https://github.com/leejimmy93/KIAT_cabernet/blob/master/F2/scanone_all_expressed_genes_1_10.slurm 

2) For permutation, since it takes too long time to run permutation on all genes, so I sampled 100 genes and ran 1000 times permutation on these genes so that median can be taken as the threshold for eQTL analysis 
https://github.com/leejimmy93/KIAT_cabernet/blob/master/F2/scanone_all_expressed_genes_perm.R 

3) transfer to whitney for analysis 

### eQTL result analysis 
```{r}

```















