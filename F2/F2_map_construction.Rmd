---
title: "F2_map_construction"
author: "Ruijuan Li"
date: "4/18/2017"
output: html_document 
---

# Goal
The goal of this analysis is to build genetic map using F2 genotyping information, F2 genotyping was done based on the SNPs we identified from its parents 

# install & load package 
```{r}
# install.packages("onemap")
# install.packages("tkrplot", type="source") 
library(tcltk)
library(tkrplot)
library(onemap)  
library(ggplot2)
library(reshape) 
library(tidyverse) 
```

# import & format data (MAC version)
```{r} 
F2_geno_data <- read.table("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/data/F2_Final_SNP_Calls", header = T)
head(F2_geno_data) 
dim(F2_geno_data) # 18226   172 
class(F2_geno_data)

rownames(F2_geno_data) <- paste(F2_geno_data$CHROM, F2_geno_data$POS, sep = "_")
F2_geno_data <- F2_geno_data[, -c(1:6)]
dim(F2_geno_data) # 18226   166 
colnames(F2_geno_data)
colnames(F2_geno_data) <- gsub("([[:print:]]+)(\\.)([[:digit:]])", "\\3", colnames(F2_geno_data))
colnames(F2_geno_data)  
```

# check missing rate & remove data with high missing rate above 0.85 
```{r}
F2_geno_data_with_missing_rate <- mutate(F2_geno_data, 
       missing_rate = round(apply(F2_geno_data, 1, function(x) sum(is.na(x)))/166, 2)) 

rownames(F2_geno_data_with_missing_rate) <- rownames(F2_geno_data) 
hist(F2_geno_data_with_missing_rate$missing_rate)
max(F2_geno_data_with_missing_rate$missing_rate) # 0.47, the highest missing rate is 0.47 

# remove markers with missing rate greater than 0.85 
F2_geno_data_with_missing_rate_filtered <-  F2_geno_data_with_missing_rate[F2_geno_data_with_missing_rate$missing_rate < 0.10,]
rownames(F2_geno_data_with_missing_rate_filtered)

dim(F2_geno_data_with_missing_rate_filtered) # 3608 167
hist(F2_geno_data_with_missing_rate_filtered$missing_rate)

F2_geno_data_with_missing_rate_filtered.final <- subset(F2_geno_data_with_missing_rate_filtered, select=-missing_rate)
rownames(F2_geno_data_with_missing_rate_filtered.final)

dim(F2_geno_data_with_missing_rate_filtered.final) # 3608 166 
rownames(F2_geno_data_with_missing_rate_filtered.final) 
```

# calculate pairwise corrlelation and remove SNPs with corrlelation greater or equal to 0.9
some SNPs should have exactly the same genotype across all individuals, they are redundant in terms of genetic map construction, so they should be removed. find those SNPs by doing correlation test. 
```{r}
F2_geno_data_t <- as.data.frame(t(F2_geno_data_with_missing_rate_filtered.final))
F2_geno_data_t.numeric <- data.matrix(F2_geno_data_t)

# delete markers with all same genotypes across individuals 
test <- apply(F2_geno_data_t.numeric, 2, function(x) length(unique(x[!is.na(x)])))
filter.polymorphsm <- test != 1 

F2_geno_data_t.numeric.2 <- F2_geno_data_t.numeric[,filter.polymorphsm]
dim(F2_geno_data_t.numeric.2) # 166 3606  

# also output save markers with same genotype across individuals
polymorphism <- test == 1
SNP.not.poly <- colnames(F2_geno_data_t.numeric)[polymorphism]
length(SNP.not.poly) # two markers are not polymorphism across individuals 
save(SNP.not.poly, file="SNP.not.poly.Rdata")

# correlation test
options(warn=-1) # suppress warning message
F2_SNP_correlation <- cor(F2_geno_data_t.numeric.2, use = "pairwise.complete.obs")
save(F2_SNP_correlation, file = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_SNP_correlation.Rdata")
options(warn=0) # unsuppress warning message
dim(F2_SNP_correlation) # 3606 3606 

# calcualte number of SNPs with correlation of 1
nrow(which(F2_SNP_correlation == 1 & lower.tri(F2_SNP_correlation), arr.ind = T, useNames = T)) # 172 pairs of SNPs have identical genotype data 

# find SNPs with correlation of 1 and remove them 
dup.cordinate <- which(F2_SNP_correlation == 1 & lower.tri(F2_SNP_correlation), arr.ind = T, useNames = F)
length(dup.cordinate) # 344
dup.cordinate.df <- as.data.frame(dup.cordinate)
sample.ID <- colnames(F2_SNP_correlation)

# extract duplicate pair information based on their coordicate
dup.pair <- data.frame(matrix(nrow = nrow(dup.cordinate), ncol = 2))
for (i in 1:nrow(dup.cordinate)){
 dup.pair[i,1] <- sample.ID[dup.cordinate[i,1]]
 dup.pair[i,2] <- sample.ID[dup.cordinate[i,2]]
}

length(dup.pair[,2]) # 172 
rem <- unique(dup.pair[,2])
length(rem) # 163 markers are removed due to pairwise correlation of 1 

# save data
save(dup.pair, file="~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/dup.pair.Rdata")
save(rem, file="~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/rem.Rdata") 

### 
F2_geno_data_1 <- F2_geno_data_with_missing_rate_filtered.final[!(rownames(F2_geno_data_with_missing_rate_filtered.final) %in% rem),]  

# remove non polymorphism SNPs 
F2_geno_data_2 <- F2_geno_data_1[!(rownames(F2_geno_data_1) %in% SNP.not.poly),]

dim(F2_geno_data_2) # 3443  166, end up with 2932 SNPs for map construction 

save(F2_geno_data_2, file="~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_data_2.Rdata") # this is non-redundant SNPs with missing data less than 0.1
``` 

# format data for onemap  
```{r}
load("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_data_2.Rdata")
dim(F2_geno_data_2) # 3443 166 
head(F2_geno_data_2) 

########### below should be corrected
# read parent data 
Ae_Ol <- read.csv("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/data/vcf.Ae.Ol.intersect.final.csv", stringsAsFactors = F)

# left join to filter Ae_Ol SNP based on F2 genotypes
Ae_Ol$index <- paste(Ae_Ol$CHROM, Ae_Ol$POS, sep = "_")
F2_geno_data_2$index <- rownames(F2_geno_data_2)
F2_geno_data_2_Ae_Ol <- 
left_join(F2_geno_data_2, Ae_Ol, by="index") %>% 
  select(-(X:ALT)) 

F2_geno_data_2_Ae_Ol <- as.matrix(F2_geno_data_2_Ae_Ol) 

# reassign genotype according to parents genotypes
F2_geno_data_2_Ae_Ol_new <- data.frame()

for (i in colnames(F2_geno_data_2_Ae_Ol)[1:166]) {
  print(i)
  for (j in 1:nrow(F2_geno_data_2_Ae_Ol)){
    if (is.na(F2_geno_data_2_Ae_Ol[j,i])){
    F2_geno_data_2_Ae_Ol_new[j,i] = "-"
    } else if (F2_geno_data_2_Ae_Ol[j,i] == "0/1"){
      F2_geno_data_2_Ae_Ol_new[j,i] = "H"
    } else if (F2_geno_data_2_Ae_Ol[j,i] == F2_geno_data_2_Ae_Ol[j,"Ae.gt"]){
      F2_geno_data_2_Ae_Ol_new[j,i] = "A"
    } else {
      F2_geno_data_2_Ae_Ol_new[j,i] = "B"
    }
  }
}

rownames(F2_geno_data_2_Ae_Ol_new) <- F2_geno_data_2_Ae_Ol[,"index"]
F2_geno_data_2_Ae_Ol_new[1:10, 1:10]
############ start working from here ############### 
dim(F2_geno_data_2_Ae_Ol_new) # 3443 166  
write.table(F2_geno_data_2_Ae_Ol_new, file = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_data_2_Ae_Ol_new.txt")
# change file format in linux 
# cat F2_geno_data_2_Ae_Ol_new.txt | sed 's/"//g' | awk '{first = $1; $1 = ""; print $0}' | sed 's/ //g' > tmp
# tail -3443 tmp > tmp.1

write.table(rownames(F2_geno_data_2_Ae_Ol_new), file = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/marker_info.txt" )
# cat marker_info.txt | awk '{print "*"$2}' | tail -5556 | sed 's/"//g' > marker_info_reform.txt

# paste marker_info_reform.txt tmp.1 | awk '{print $1 " " $2}' > F2_geno_for_one_map.txt 
# cat header_one_map_input F2_geno_for_one_map.txt > F2_geno_for_one_map_final.txt 
# change header info: maker number to the right marker number 
```

# calculate two point rf & assign to linkage groups (on whitney) 
```{r}
# F2_map_construction_LOD3_rf0.5_missing_0.10.R 
```

### assign markers to different linkage groups based on their chromsome assignment 
use this method to test if I get correct result, test it on one chromosome with the least number of markers 
```{r}
# get the number of markers for each chromosome 
load("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_data_2.Rdata")
dim(F2_geno_data_2) # 3443 166

F2_geno_data_2$Chr <- gsub("([[:print:]]+)(_)([[:digit:]]+)", "\\1", rownames(F2_geno_data_2)) 
F2_geno_data_2$Pos <- gsub("([[:print:]]+)(_)([[:digit:]]+)", "\\3", rownames(F2_geno_data_2)) 
F2_geno_data_2$index <- seq(1: nrow(F2_geno_data_2))

head(F2_geno_data_2[F2_geno_data_2$Chr=="chrA04",],1)
tail(F2_geno_data_2[F2_geno_data_2$Chr=="chrC09",],1)

sum(F2_geno_data_2$Chr=="chrA01") # 221 1-221  
sum(F2_geno_data_2$Chr=="chrA02") # 92 222-313
sum(F2_geno_data_2$Chr=="chrA03") # 303 314-616
sum(F2_geno_data_2$Chr=="chrA04") # 165 617-781
sum(F2_geno_data_2$Chr=="chrA05") # 156 782-937
sum(F2_geno_data_2$Chr=="chrA06") # 439 938-1376
sum(F2_geno_data_2$Chr=="chrA07") # 290 1377-1666
sum(F2_geno_data_2$Chr=="chrA08") # 178 1667-1844
sum(F2_geno_data_2$Chr=="chrA09") # 352 1845-2196
sum(F2_geno_data_2$Chr=="chrA10") # 295 2197-2491
sum(F2_geno_data_2$Chr=="chrC01") # 135 2492-2626
sum(F2_geno_data_2$Chr=="chrC02") # 67 2627-2693
sum(F2_geno_data_2$Chr=="chrC03") # 188 2694-2881
sum(F2_geno_data_2$Chr=="chrC04") # 161 2882-3042
sum(F2_geno_data_2$Chr=="chrC05") # 51 3043-3093
sum(F2_geno_data_2$Chr=="chrC06") # 105 3094-3198
sum(F2_geno_data_2$Chr=="chrC07") # 124 3199-3322
sum(F2_geno_data_2$Chr=="chrC08") # 73 3323-3395
sum(F2_geno_data_2$Chr=="chrC09") # 48 3396-3443  

i = 1
index = vector()
for (ch in unique(F2_geno_data_2$Chr)){
  while (F2_geno_data_2$Chr[i]==ch){
      i = i + 1 
  }
  print (i-1)
  index[ch] = i-1
}

index 
# test on C09 
# https://github.com/leejimmy93/KIAT/map_A01.R .... mapC09.R 
```

### use madmapper to assign markers to clusters/LGs 
[http://cgpdb.ucdavis.edu/XLinkage/MadMapper/Genetic_Map_MadMapper_Arabidopsis.html]

### running madmapper 
### 1) format marker data to madmapper accepted format (on MAC)
```{r}
# cat F2_geno_data_2_Ae_Ol_new.txt | sed 's/"//g' | tr " " "\t" > F2_geno_data_m.txt 
# vim edit add ";" to the 1st line 
# seq 166 | tr "\n" "\t" > number_line_header 
# vim edit add ";" to number_line_header
# cat number_line_header F2_geno_data_m.txt > mv F2_geno_data_m.txt 
# mv F2_geno_data_m.txt F2_geno_data_m.loc 
# wc -l F2_geno_data_m.loc 3444 
# cat F2_geno_data_m.loc | awk '{print NF}' | sort | uniq 167 
# scp to whitney 
```

* madmapper (on whitney)
http://cgpdb.ucdavis.edu/XLinkage/MadMapper/#Part_2
```{r} 
# https://github.com/leejimmy93/KIAT/blob/master/madmapper.sh
# the output file we should check is tree.clust file 
```

check madmapper output (export *.tree.clust file to Excel, and decide which SNP belong to which LG based on tree value) /Users/ruijuanli/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/missing_rate_0.10/F2_geno_data_m_loc_mmout.x_tree_clust.xlsx 

* get linkage group from madmapper generated tree.clust file 
```{r}
madmapper.result <- read.csv("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/missing_rate_0.10/F2_geno_data_m_loc_mmout.x_tree_clust.csv", header = F)

LG.A01 <- madmapper.result$V26[1:212]
LG.C01 <- madmapper.result$V26[225:355]
LG.A03 <- madmapper.result$V26[356:621]
LG.C03 <- madmapper.result$V26[659:844]
LG.A09 <- madmapper.result$V26[845:1186]
LG.C08 <- madmapper.result$V26[1187:1248]
LG.A06 <- madmapper.result$V26[1261:1699]
LG.A05 <- madmapper.result$V26[1717:1871]
LG.C05 <- madmapper.result$V26[1872:1909] 
LG.A02 <- madmapper.result$V26[1924:2015]
LG.A04 <- madmapper.result$V26[2016:2178]
LG.C04 <- madmapper.result$V26[2179:2335]
LG.A07 <- madmapper.result$V26[2336:2626]
LG.A10 <- madmapper.result$V26[2627:2921]
LG.C06 <- madmapper.result$V26[2922:3026]
LG.C09 <- madmapper.result$V26[3027:3062]
LG.A08 <- madmapper.result$V26[3075:3251]
LG.C02 <- madmapper.result$V26[3252:3319]
LG.C07 <- madmapper.result$V26[3320:3442]

######### unincorported LGs
LG.A01.2 <- madmapper.result$V26[213:224]
LG.A03.2 <- madmapper.result$V26[622:658]
LG.A09.2 <- madmapper.result$V26[1251:1259]
LG.C04.C05 <- madmapper.result$V26[1703:1716]
LG.C05.2 <- madmapper.result$V26[1910:1913]
LG.C08.2 <- madmapper.result$V26[1914:1923]
LG.C09.2 <- madmapper.result$V26[3063:3073] 
#########

LG.A <- list(LG.A01, LG.A01.2, LG.A02, LG.A03, LG.A03.2, LG.A04, LG.A05, LG.A06, LG.A07, LG.A08, LG.A09, LG.A09.2, LG.A10)

LG.C <- list(LG.C01, LG.C02, LG.C03, LG.C04, LG.C04.C05, LG.C05, LG.C05.2, LG.C06, LG.C07, LG.C08, LG.C08.2, LG.C09, LG.C09.2)
length(LG.A) # 13 linkage groups 
length(LG.C) # 13 linkage groups 
```  

# get index for the above markers in different linkage group 
```{r}
load("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/missing_rate_0.10/twopts.LOD3_rf0.5.Rdata")
twopts.f2.LOD3_rf0.5$marnames 

group.A <- list()

for (i in 1:length(LG.A)) {
  group.A[[i]] <-  which(twopts.f2.LOD3_rf0.5$marnames %in% LG.A[[i]])
}
group.A

group.C <- list()

for (i in 1:length(LG.C)) {
  group.C[[i]] <-  which(twopts.f2.LOD3_rf0.5$marnames %in% LG.C[[i]])
}

group.C
save(group.A, group.C, file = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/group.Rdata")
```

#### order within each chromosome 
```{r}
# scp group.A & group.C to whitney 
# https://github.com/leejimmy93/KIAT/blob/master/F2/map_A.R
# https://github.com/leejimmy93/KIAT/blob/master/F2/map_C.R 
``` 

#### analyze result 
C08 eg
```{r}
######## import data #######
# marker data 
F2.data <- read.mapmaker(file="~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_for_one_map_final.txt") 
F2.data 

# two-point rf data  
load("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/missing_rate_0.10/twopts.LOD3_rf0.5.Rdata")

# order data 
load("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/missing_rate_0.10/madmapper/LG.f2.ord.C8.Rdata")

# get order 
LG.f2.C8 <- make.seq(LG.f2.ord.C8[[10]], "force") 
LG.f2.C8 # 62 

rf.graph.table(LG.f2.C8)
par(mfrow=c(1,1))
draw.map(LG.f2.C8, names= F, grid=F, cex.mrk=0.5, cex.grp=0.75, horizontal=T)  
write.map(LG.f2.C8, "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/LG.f2.C8.map") 

# use safe mode 
LG.f2.C8.safe <- make.seq(LG.f2.ord.C8[[10]], "safe") 
LG.f2.C8.safe # 40 
rf.graph.table(LG.f2.C8.safe)
par(mfrow=c(1,1))
draw.map(LG.f2.C8.safe, names= F, grid=F, cex.mrk=0.5, cex.grp=0.75, horizontal=T)  
write.map(LG.f2.C8.safe, "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/LG.f2.C8.safe.map")

#### check alternative order 
ripple.seq(LG.f2.C8, ws = 5, LOD = 3)

```
* Is there need to use ripple.seq() to compare all possible orders, cannot output the result... 

### Now import C subgenome 
### analyze result C sub genome 
### import data 
```{r}
######## import data #######
# marker data 
F2.data <- read.mapmaker(file="~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_for_one_map_final.txt") 
F2.data 
# This is an object of class 'f2.onemap'
#     No. individuals:     166 
#     No. markers:         3443 
#     Percent genotyped:   95 
# 
#     Number of markers per type:
#        AA : AB : BB -->  3443
# 
# This data contains no phenotypic information

# two-point rf data  
load("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/missing_rate_0.10/twopts.LOD3_rf0.5.Rdata")

# order data 
load("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/missing_rate_0.10/madmapper/LG.f2.ord.C.Rdata")

# get order 
LG.f2.C <- list()

for (i in 1:length(LG.f2.ord.C)){
  LG.f2.C[[i]] <- make.seq(LG.f2.ord.C[[i]], "force") 
}

# rf.graph.table(LG.f2.C[[i]])
par(mfrow=c(1,1))
draw.map(LG.f2.C, names= F, grid=F, cex.mrk=0.5, cex.grp=0.75, horizontal=T)  
write.map(LG.f2.C, "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/LG.f2.C.map") 

# use safe mode 
LG.f2.C.safe <- list()

for (i in 1:length(LG.f2.ord.C)){
  LG.f2.C.safe[[i]] <- make.seq(LG.f2.ord.C[[i]], "safe") 
} 

# rf.graph.table(LG.f2.C.safe[[13]])
par(mfrow=c(1,1))
draw.map(LG.f2.C.safe, names= F, grid=F, cex.mrk=0.5, cex.grp=0.75, horizontal=T)  
write.map(LG.f2.C.safe, "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/LG.f2.C.safe.map")
```

### Now import A subgenome 
### analyze result C sub genome 
### import data 
```{r}
######## import data #######
# marker data 
F2.data <- read.mapmaker(file="~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_for_one_map_final.txt") 
F2.data

# two-point rf data  
load("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/missing_rate_0.10/twopts.LOD3_rf0.5.Rdata")

# order data 
load("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/missing_rate_0.10/madmapper/LG.f2.ord.A.Rdata")

# get order 
LG.f2.A <- list()

for (i in 1:length(LG.f2.ord.A)){
  LG.f2.A[[i]] <- make.seq(LG.f2.ord.A[[i]], "force") 
}

rf.graph.table(LG.f2.A[[7]])
par(mfrow=c(1,1))
draw.map(LG.f2.A, names= F, grid=F, cex.mrk=0.5, cex.grp=0.75, horizontal=T)  
write.map(LG.f2.A, "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/LG.f2.A.map") 

# use safe mode 
LG.f2.A.safe <- list()

for (i in 1:length(LG.f2.ord.A)){
  LG.f2.A.safe[[i]] <- make.seq(LG.f2.ord.A[[i]], "safe") 
} 

# rf.graph.table(LG.f2.C.safe[[13]])
par(mfrow=c(1,1))
draw.map(LG.f2.A.safe, names= F, grid=F, cex.mrk=0.5, cex.grp=0.75, horizontal=T)  
write.map(LG.f2.A.safe, "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/LG.f2.A.safe.map")
```

# R/qtl package to plot LOD & rf headmap to check marker order & assignment to LG correctness  
```{r}
library("qtl")

LG.f2.C <- read.cross("mm", file = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_for_one_map_final.txt", mapfile = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/LG.f2.C.map")

summary(LG.f2.C)
plotMap(LG.f2.C)
# plot.rf(LG.f2.C)

totmar(LG.f2.C) # 945

LG.f2.C.safe <- read.cross("mm", file = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_for_one_map_final.txt", mapfile = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/LG.f2.C.safe.map")

summary(LG.f2.C.safe)
plotMap(LG.f2.C.safe)
# plot.rf(LG.f2.C.safe)

totmar(LG.f2.C.safe) # 631 

# geno.image(LG.f2.C, alternate.chrid = T) # grid with color pixels for different genotypes
# geno.image(LG.f2.A, alternate.chrid = T) # grid with color pixels for different genotypes

# save(newmap.drop.marker, file = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/newmap.drop.marker.Rdata")

####### A sub
LG.f2.A <- read.cross("mm", file = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_for_one_map_final.txt", mapfile = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/LG.f2.A.map")

summary(LG.f2.A)
plotMap(LG.f2.A)
# plot.rf(LG.f2.A)

totmar(LG.f2.C) # 945

LG.f2.A.safe <- read.cross("mm", file = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_for_one_map_final.txt", mapfile = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/LG.f2.A.safe.map")

summary(LG.f2.A.safe)
plotMap(LG.f2.A.safe)
# plot.rf(LG.f2.A.safe) 
```







######### above is for madmapper 

########### what if I use mapping order to order markers ################
get marker index within each chromosome 
```{r}
load("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_data_2.Rdata")
dim(F2_geno_data_2) # 3443 166

F2_geno_data_2$Chr <- gsub("([[:print:]]+)(_)([[:digit:]]+)", "\\1", rownames(F2_geno_data_2)) 
F2_geno_data_2$Pos <- gsub("([[:print:]]+)(_)([[:digit:]]+)", "\\3", rownames(F2_geno_data_2)) 
F2_geno_data_2$index <- seq(1: nrow(F2_geno_data_2))

# figure out the index positon within each chromosome for all chromosomes 
F2_geno_data_info <- F2_geno_data_2[,c("Chr", "Pos", "index")]
dim(F2_geno_data_info) # 3443 3 
F2_geno_data_info[1:10,]

out <- split( F2_geno_data_info, f = F2_geno_data_info$Chr)
length(out) # 19 
out

order <- list()

for (i in 1:length(out)){
  out[[i]]$Pos <- as.numeric(out[[i]]$Pos)
  order[[i]] <- out[[i]][order(out[[i]]$Pos),]$index 
}

order 
save(order, file = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/missing_rate_0.10/order.Rdata")
```

use mapping order to order markers  
```{r}
# load data 
F2.data <- read.mapmaker(file="~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_for_one_map_final.txt") 
load("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/missing_rate_0.10/twopts.LOD3_rf0.5.Rdata") # LOD=3, max rf=0.5 
load("~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/missing_rate_0.10/order.Rdata")

# must unload tydiverse, otherwise error, still need to fix these two lines 
unloadNamespace("tidyverse")
detach("package:purrr", unload=TRUE) 

# mapping order 
LG.f2.arbi <- list()

for (i in 1:length(order)){
  tmp <- make.seq(twopts.f2.LOD3_rf0.5, order[[i]])
  LG.f2.arbi[[i]] <- map(tmp)
} 

rf.graph.table(LG.f2.arbi[[19]])
par(mfrow=c(1,1))
draw.map(LG.f2.arbi, names= F, grid=F, cex.mrk=0.5, cex.grp=0.75, horizontal=T)  
# write.map(LG.f2.arbi, "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/LG.f2.arbi.map") 

########### use R/qtl ######################## 
# data import 
library("qtl")

# import data 
map.F2 <- read.cross("mm", file = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/F2_geno_for_one_map_final.txt", mapfile = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/LG.f2.arbi.map")

# get rf figure & map figure for mapping order based map 
summary(map.F2)
plotMap(map.F2)
# plot.rf(map.F2) 

# newmap <- est.map(map.F2, tol=1e-6, map.function="kosambi") 
# newmap doesn't look better at all 
```




# a bunch of checks in R/qtl 
```{r}
summary(map.F2)
plotMap(map.F2)
# plot.rf(map.F2)

totmar(map.F2)

# 1) segregation distortion 
test <- geno.table(map.F2)
seg_dist <- test[test$P.value < 0.01,]
seg_dist
dim(seg_dist) # 340 markers 

##### drop markers with segregation distortion 
# map.F2.after.drop <- drop.marker(map.F2, rownames(seg_dist)) # doesn't work... 
map.F2

# rffull.Asub <- pull.rf(map.F2)

# work with each chromosome seperately 
# plot.rf(map.F2, chr = "chrA02")
rfA02 <- pull.rf(map.F2, chr = 'chrA02')
chrA02 <- markernames(map.F2, chr = 'chrA02')
chrA02

# 2) compare individual's genotype similarity. Assumption: no two individuals with very similary genotypes
cg <- comparegeno(map.F2) 
dim(cg) 
hist(cg, breaks = 200,
     xlab="Proportion of identical genotypes")
rug(cg)
which(cg >0.9, arr.ind = TRUE) # no individuals with high genotype similarities

# No apparent problem, make a plot to see the data
plot.rf(map.F2, col.scheme = "redblue", alternate.chrid = T)

# looks like they are on the right chromosomes but wrong order within each chromosome

# estimate the genetic map
nm <- est.map(map.F2)
plot(nm, alternate.chrid = T) 
pull.map(cross_m, chr = c("A03","A05")) # longer length was plot than what was indicated in the data? 
pull.map(cross_m) 
```




### appendix 
### check double cross over 
```{r}
cross.drop.marker <- LG.f2.C8

for (chr in names(cross.drop.marker$geno)) { # for each chromosome in cross genotype data
  my.chr <- get(chr,cross.drop.marker$geno) # return the genotype data, including data & map
  print(paste(chr,"NA before",sum(is.na(my.chr$data)))) 
  if(ncol(my.chr$data) > 3) { 
    my.chr$data[,2:(ncol(my.chr$data)-1)] <- sapply(2:(ncol(my.chr$data)-1),function(i) {
      apply(my.chr$data[,(i-1):(i+1)],1,function(gt) {
        if (any(is.na(gt))) return(gt[2]) #technically should be looking at the next genotyped marker.
        if ( (length(unique(gt)) == 2) & (gt[1] == gt[3])) return(NA)
        if ( length(unique(gt))  == 3) return(NA)
        return(gt[2])
      })
    })
  }
  cross.drop.marker$geno <- within(cross.drop.marker$geno,assign(chr,my.chr))
  print(paste(chr,"NA after",sum(is.na(get(chr,cross.drop.marker$geno)$data))))
} 

write.csv(pull.geno(cross.drop.marker),file="~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/cross.drop.marker.csv")

newmap.drop.marker <- est.map(cross.drop.marker,verbose=T,error.prob=.01) # why going through 
# the last section of code doesn't assign new map 
plot.map(map.F2, alternate.chrid = T) # the old genetic map
plot.map(map.F2,newmap.drop.marker, alternate.chrid = T) # genetic map comparison

geno.image(cross.drop.marker, alternate.chrid = T) # grid with color pixels for different genotypes

save(newmap.drop.marker, file = "~/Desktop/Brassica_project/KIAT_RNA_seq/F2/output/newmap.drop.marker.Rdata")
``` 


